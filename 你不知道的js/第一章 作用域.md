# 作用域

变量储存在哪里？程序需要时是如何找到他们的？

这些问题说明需要一套设计良好的规则来储存变量，并且可以方便的找到这些变量。这套规则被称为*作用域*。

## 1 编译原理

1. 在传统的编译语言中，源代码在执行前一般会经历三个步骤，统称为“编译”。
    - 分词/词法分析 这个过程会将由字符组成的字符串分解成(对编程语言来说)有意义的代码块，这些代 码块被称为词法单元(token)。例如，考虑程序var a = 2;。这段程序通常会被分解成 为下面这些词法单元:var、a、=、2 、;。空格是否会被当作词法单元，取决于空格在 这门语言中是否具有意义。
    - 解析/语法分析 这个过程是将词法单元流(数组)转换成一个由元素逐级嵌套所组成的代表了程序语法 结构的树。这个树被称为“抽象语法树”(Abstract Syntax Tree，AST)。
    - 代码生产 将 AST 转换为可执行代码的过程称被称为代码生成。这个过程与语言、目标平台等息 息相关。抛开具体细节，简单来说就是有某种方法可以将 var a = 2; 的 AST 转化为一组机器指 令，用来创建一个叫作 a 的变量(包括分配内存等)，并将一个值储存在 a 中。

2. 比起那些编译过程只有三个步骤的语言的编译器，JavaScript 引擎要复杂得多。例如，在 语法分析和代码生成阶段有特定的步骤来对运行性能进行优化，包括对冗余元素进行优化 等。

3. 简单地说，任何 JavaScript 代码片段在执行前都要进行编译(通常就在执行前)。因此， JavaScript 编译器首先会对 var a = 2; 这段程序进行编译，然后做好执行它的准备，并且 通常马上就会执行它。

## 2 作用域

1. 变量的赋值操作会执行两个动作，首先编译器会在当前作用域中声明一个变量(如 果之前没有声明过)，然后在运行时引擎会在作用域中查找该变量，如果能够找到就会对它赋值。

2. js代码编译运行过程主要有三个角色
    - 引擎 从头到尾负责整个 JavaScript 程序的编译及执行过程
    - 编译器 负责语法分析及代码生成等
    - 作用域 负责收集并维护由所有声明的标识符(变量)组成的一系列查 询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限

3. LHS（左查询）和RHS（右查询）

    LHS是去找到变量的容器本身，以便进行赋值操作；RHS是查询并找到某个变量的值。

    LHS失败，不会报错，而是在全局添加这个变量
    RHS失败，会报错ReferenceError

## 3 总结

作用域是一套规则，用于确定在何处以及如何查找变量(标识符)。如果查找的目的是对
变量进行赋值，那么就会使用 LHS 查询;如果目的是获取变量的值，就会使用 RHS 查询。

JavaScript引擎首先会在代码执行前对其进行编译，在这个过程中，像var a = 2这样的声 明会被分解成两个独立的步骤:
- 首先，var a 在其作用域中声明新变量。这会在最开始的阶段，也就是代码执行前进行。
- 接下来，a = 2 会查询(LHS 查询)变量 a 并对其进行赋值。
